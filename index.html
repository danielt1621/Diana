<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Birthday Reflection</title>
            <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }
        :root {
            --shell-max-width: min(100%, 520px);
            --content-radius: clamp(18px, 5vw, 28px);
            --content-padding-block: clamp(22px, 6vw, 34px);
            --content-padding-inline: clamp(18px, 5vw, 28px);
            --body-padding-top: clamp(24px, 7vh, 64px);
            --body-padding-bottom: clamp(36px, 9vh, 96px);
            --body-padding-inline: clamp(14px, 6vw, 36px);
            --section-gap: clamp(16px, 4vh, 28px);
        }
        body {
            margin: 0;
            min-height: 100vh;
            min-height: 100dvh;
            padding: var(--body-padding-top) var(--body-padding-inline) var(--body-padding-bottom);
            padding-top: calc(var(--body-padding-top) + env(safe-area-inset-top));
            padding-bottom: calc(var(--body-padding-bottom) + env(safe-area-inset-bottom));
            font-family: 'Georgia', serif;
            color: #fff;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-overflow-scrolling: touch;
            gap: var(--section-gap);
            -webkit-text-size-adjust: 100%;
        }
        .app-shell {
            position: relative;
            width: min(100%, var(--shell-max-width));
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: var(--section-gap);
        }
        body.intro-active .app-shell,
        body.intro-active #aurora {
            filter: blur(6px);
            pointer-events: none;
        }
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #error-message {
            background: #222;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
        }
        #aurora {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            animation: fadeIn 2s ease-in forwards;
            overflow: hidden;
            z-index: 1;
        }
        #aurora-video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            object-fit: cover;
            filter: brightness(0.8);
        }
        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 2s infinite alternate;
            opacity: 0.8;
        }
        @keyframes twinkle {
            0% { opacity: 0.5; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        .star:nth-child(1) { top: 10%; left: 20%; width: 2px; height: 2px; animation-delay: 0s; }
        .star:nth-child(2) { top: 15%; left: 50%; width: 3px; height: 3px; animation-delay: 0.5s; }
        .star:nth-child(3) { top: 20%; left: 80%; width: 1px; height: 1px; animation-delay: 1s; }
        .star:nth-child(4) { top: 25%; left: 30%; width: 2px; height: 2px; animation-delay: 1.5s; }
        .star:nth-child(5) { top: 30%; left: 60%; width: 1px; height: 1px; animation-delay: 0.2s; }
        .star:nth-child(6) { top: 35%; left: 10%; width: 3px; height: 3px; animation-delay: 0.8s; }
        .star:nth-child(7) { top: 40%; left: 70%; width: 2px; height: 2px; animation-delay: 1.2s; }
        .star:nth-child(8) { top: 45%; left: 40%; width: 1px; height: 1px; animation-delay: 0.4s; }
        .star:nth-child(9) { top: 50%; left: 90%; width: 2px; height: 2px; animation-delay: 1s; }
        .star:nth-child(10) { top: 55%; left: 25%; width: 3px; height: 3px; animation-delay: 0.6s; }
        .star:nth-child(11) { top: 60%; left: 55%; width: 1px; height: 1px; animation-delay: 1.4s; }
        .star:nth-child(12) { top: 65%; left: 15%; width: 2px; height: 2px; animation-delay: 0.3s; }
        .star:nth-child(13) { top: 70%; left: 85%; width: 3px; height: 3px; animation-delay: 0.9s; }
        .star:nth-child(14) { top: 75%; left: 35%; width: 1px; height: 1px; animation-delay: 1.3s; }
        .star:nth-child(15) { top: 80%; left: 65%; width: 2px; height: 2px; animation-delay: 0.7s; }
        .star:nth-child(16) { top: 85%; left: 5%; width: 3px; height: 3px; animation-delay: 1.1s; }
        .star:nth-child(17) { top: 90%; left: 45%; width: 1px; height: 1px; animation-delay: 0.1s; }
        .star:nth-child(18) { top: 95%; left: 75%; width: 2px; height: 2px; animation-delay: 1.6s; }
        .star:nth-child(19) { top: 5%; left: 95%; width: 3px; height: 3px; animation-delay: 0s; }
        .star:nth-child(20) { top: 8%; left: 5%; width: 1px; height: 1px; animation-delay: 1.7s; }
        #content {
            position: relative;
            z-index: 10;
            width: 100%;
            background: rgba(8, 26, 38, 0.82);
            border-radius: var(--content-radius);
            padding: var(--content-padding-block) var(--content-padding-inline);
            display: flex;
            flex-direction: column;
            gap: clamp(16px, 4vw, 28px);
            align-items: stretch;
            text-align: center;
            box-shadow: 0 32px 60px rgba(0, 0, 0, 0.36);
            backdrop-filter: blur(14px);
            opacity: 0;
            animation: fadeIn 1.8s ease 1s forwards;
        }
        h1 {
            margin: 8px 0 6px;
            font-size: clamp(1.9rem, 1.8vw + 1.4rem, 2.4rem);
            animation: glow 4s infinite;
        }
        p {
            margin: 0;
            font-size: 1.05em;
            font-style: italic;
            line-height: 1.4;
        }
        #content > p {
            margin: 0 auto;
            max-width: 42ch;
            font-size: clamp(1rem, 0.6vw + 1rem, 1.12rem);
        }
        button, input, textarea {
            font-family: 'Georgia', serif;
            border: none;
            border-radius: 12px;
            padding: clamp(12px, 3.5vw, 16px) clamp(16px, 4.5vw, 22px);
            font-size: clamp(1rem, 0.3vw + 0.98rem, 1.08rem);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        button {
            cursor: pointer;
            box-shadow: 0 0 12px rgba(0,255,200,0.25);
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 0 18px rgba(0,255,200,0.45);
        }
        button:focus-visible {
            outline: 2px solid rgba(0,255,200,0.6);
            outline-offset: 2px;
        }
        button.primary {
            background: linear-gradient(135deg, rgba(0,255,200,0.78), rgba(0,180,255,0.74));
            color: #021619;
            font-weight: 600;
        }
        button.primary:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        button.secondary {
            background: rgba(255,255,255,0.12);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.25);
        }
        button.ghost {
            background: transparent;
            border: 1px solid rgba(255,215,0,0.5);
            color: #ffe679;
            box-shadow: 0 0 14px rgba(255,215,0,0.2);
        }
        button.icon {
            padding: 0;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(0,255,200,0.45);
            color: #b8fff0;
            box-shadow: 0 0 14px rgba(0,255,200,0.25);
        }
        #guide-button {
            position: absolute;
            top: 16px;
            right: 16px;
        }
        input, textarea {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(0,255,200,0.2);
            color: #fff;
            box-shadow: inset 0 0 12px rgba(0,255,200,0.08);
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: rgba(0,255,200,0.65);
            box-shadow: inset 0 0 18px rgba(0,255,200,0.18);
        }
        #initial-controls {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: stretch;
        }
        .primary-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #response {
            display: none;
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(0,255,200,0.25);
            border-radius: 20px;
            padding: clamp(18px, 4vw, 26px) clamp(14px, 4vw, 22px);
            box-shadow: 0 0 24px rgba(0,255,200,0.15);
            text-align: left;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #response.is-visible {
            display: block;
            opacity: 1;
        }
        #response.is-pending {
            display: block;
            opacity: 0.65;
        }
        #conversation-track {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 14px;
        }
        .crumb {
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 0.8em;
            letter-spacing: 0.4px;
            background: rgba(0,255,200,0.18);
            border: 1px solid rgba(0,255,200,0.35);
            color: #b3ffe5;
            backdrop-filter: blur(6px);
            box-shadow: 0 0 12px rgba(0,255,200,0.12);
            animation: glowPulse 3.5s ease-in-out infinite;
        }
        .crumb.wish { background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.45); color: #ffe9a6; }
        .crumb.note { background: rgba(255,140,0,0.18); border-color: rgba(255,140,0,0.4); color: #ffd4a1; }
        .crumb.reflection { background: rgba(135,206,250,0.2); border-color: rgba(135,206,250,0.4); color: #d1f1ff; }
        #conversation-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: min(340px, 48vh);
            overflow-y: auto;
            padding-right: clamp(4px, 1.5vw, 8px);
        }
        #conversation-body::-webkit-scrollbar { width: 6px; }
        #conversation-body::-webkit-scrollbar-thumb { background: rgba(0,255,200,0.44); border-radius: 6px; }
        .bubble {
            max-width: 86%;
            padding: 14px 16px;
            border-radius: 16px;
            line-height: 1.5;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 12px 26px rgba(0,0,0,0.24);
            align-self: flex-start;
            animation: fadeSlide 0.45s ease;
        }
        .bubble.wish { align-self: flex-start; background: linear-gradient(135deg, rgba(255,215,0,0.25), rgba(0,0,0,0.4)); border-color: rgba(255,215,0,0.45); }
        .bubble.note { align-self: center; background: linear-gradient(135deg, rgba(255,140,0,0.25), rgba(0,0,0,0.35)); border-color: rgba(255,140,0,0.35); }
        .bubble.reflection { align-self: flex-end; background: linear-gradient(135deg, rgba(0,255,200,0.22), rgba(0,0,0,0.45)); border-color: rgba(0,255,200,0.35); }
        .bubble.thinking { align-self: center; font-style: italic; opacity: 0.8; }
        #followup-wrapper {
            display: none;
            flex-direction: column;
            gap: clamp(10px, 3vw, 16px);
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(0,255,200,0.2);
            border-radius: 16px;
            padding: clamp(16px, 4vw, 22px);
            box-shadow: 0 18px 32px rgba(0,0,0,0.25);
            backdrop-filter: blur(6px);
            text-align: left;
        }
        #followup-wrapper label {
            font-size: 0.92em;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.85);
        }
        #followup-input {
            min-height: 90px;
            resize: vertical;
        }
        .action-bar {
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 3vw, 14px);
            margin-top: 6px;
        }
        .action-bar button {
            width: 100%;
        }
        .action-bar span#stored-message {
            text-align: center;
            font-size: 0.85em;
        }
        #stored-list {
            margin-top: 18px;
            display: none;
            width: 100%;
            background: rgba(0,0,0,0.48);
            padding: clamp(18px, 4vw, 24px);
            border-radius: clamp(16px, 4vw, 20px);
            box-shadow: 0 0 24px rgba(0,255,200,0.14);
            text-align: left;
        }
        #stored-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        #stored-list li {
            background: rgba(255,255,255,0.08);
            padding: 16px;
            border-radius: 14px;
            box-shadow: 0 14px 26px rgba(0,0,0,0.28);
        }
        .conversation-preview {
            margin-top: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(0,255,200,0.2);
            border-radius: 12px;
            padding: 12px;
            line-height: 1.45;
        }
        .stored-event {
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.15);
        }
        .stored-event:last-child { border-bottom: none; }
        .stored-event strong {
            display: block;
            margin-bottom: 4px;
            color: rgba(0,255,200,0.75);
        }
        .stored-event.wish strong { color: rgba(255,215,0,0.75); }
        .stored-event.note strong { color: rgba(255,140,0,0.75); }
        .stored-event.reflection strong { color: rgba(135,206,250,0.85); }
        .row-actions {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translate(-50%, -20px);
            padding: 12px 20px;
            background: rgba(10,20,30,0.85);
            border: 1px solid rgba(0,255,200,0.4);
            border-radius: 12px;
            color: #ffd700;
            box-shadow: 0 0 18px rgba(0,255,200,0.25);
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
            pointer-events: none;
            z-index: 40;
            max-width: 90%;
        }
        .toast.show { opacity: 1; transform: translate(-50%, 0); }
        .toast.warn { border-color: rgba(255,215,0,0.7); color: #ffe9a6; }
        .toast.error { border-color: rgba(231,76,60,0.7); color: #ffd3c8; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.75);
            z-index: 45;
        }
        .modal-overlay.show { display: flex; }
        .modal-card {
            position: relative;
            background: rgba(5, 15, 25, 0.92);
            border: 1px solid rgba(0,255,200,0.35);
            border-radius: 18px;
            padding: clamp(22px, 5vw, 28px);
            width: min(92vw, 360px);
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.45);
        }
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 18px;
            flex-wrap: wrap;
        }
        .modal-actions button { min-width: 120px; }
        .modal-actions .confirm-btn { background: linear-gradient(#e74c3c, #c0392b); color: #fff; }
        .modal-actions .cancel-btn {
            background: rgba(255,255,255,0.15);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.35);
        }
        .info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 45;
        }
        .info-overlay.show { display: flex; }
        .info-card {
            position: relative;
            width: min(92vw, 440px);
            background: rgba(5, 25, 35, 0.92);
            border: 1px solid rgba(0,255,200,0.35);
            border-radius: 18px;
            padding: clamp(24px, 5vw, 32px);
            text-align: left;
            box-shadow: 0 30px 60px rgba(0,0,0,0.45);
            animation: floatUp 0.5s ease;
        }
        .info-card h2 { margin-top: 0; text-align: center; letter-spacing: 0.8px; }
        .info-card ol { padding-left: 18px; margin: 0 0 12px; }
        .info-card li { margin-bottom: 8px; }
        .info-card .footnote { font-size: 0.85em; color: rgba(255,255,255,0.75); text-align: center; }
        button.icon.close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(0,0,0,0.35);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: none;
        }
        .emoji-heart, .emoji-star {
            display: inline-block;
            margin-left: 0.2em;
        }
        .emoji-heart {
            animation: heartbeat 1.6s ease-in-out infinite;
            transform-origin: center;
            filter: drop-shadow(0 0 6px rgba(255, 64, 129, 0.45));
        }
        .emoji-star {
            animation: shimmer 2.4s ease-in-out infinite;
            filter: drop-shadow(0 0 6px rgba(255, 255, 150, 0.55));
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes glow {
            0% { text-shadow: 0 0 5px #ffd700; }
            50% { text-shadow: 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ffd700; }
        }
        @keyframes pulse {
            0% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.5; transform: scale(1); }
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.18); }
            40% { transform: scale(0.94); }
            60% { transform: scale(1.12); }
            80% { transform: scale(1.02); }
        }
        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.85; }
            30% { transform: rotate(6deg) scale(1.12); opacity: 1; }
            60% { transform: rotate(-6deg) scale(0.97); opacity: 0.92; }
        }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(0,255,200,0.35); }
            50% { box-shadow: 0 0 18px rgba(0,255,200,0.65); }
        }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes floatUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #intro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.8);
            z-index: 20;
            opacity: 1;
            transition: opacity 2s ease-in-out;
            padding: var(--body-padding-top) clamp(18px, 6vw, 36px) var(--body-padding-bottom);
            text-align: center;
            gap: clamp(12px, 4vw, 28px);
        }
        #intro.hidden { opacity: 0; pointer-events: none; }
        #intro h1 {
            font-size: clamp(2.2rem, 4vw + 1.6rem, 3rem);
            perspective: 1000px;
            animation: flipIn 2s ease-in-out;
            text-shadow: 0 0 10px rgba(0,0,0,0.5), 0 0 20px rgba(0,255,200,0.3);
        }
        #intro p {
            max-width: min(560px, 90vw);
            font-size: clamp(1.05rem, 2vw + 1rem, 1.35rem);
            opacity: 0;
            animation: fadeInText 2s ease-in 2s forwards;
            text-shadow: 0 0 10px rgba(0,0,0,0.5), 0 0 20px rgba(0,255,200,0.3);
        }
        #skip-text {
            font-size: clamp(0.95rem, 0.4vw + 0.85rem, 1rem);
            color: #ffd700;
            cursor: pointer;
            margin-top: clamp(16px, 4vw, 28px);
            text-decoration: underline;
        }
        @keyframes flipIn {
            0% { transform: rotateY(-180deg); opacity: 0; }
            100% { transform: rotateY(0); opacity: 1; }
        }
        @keyframes fadeInText {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        button.delete-btn {
            background: linear-gradient(#e74c3c, #c0392b);
            color: #fff;
        }
        button.delete-btn:hover {
            box-shadow: 0 0 15px rgba(231,76,60,0.8);
        }
        @media (min-width: 420px) {
            .primary-actions { flex-direction: row; }
            .primary-actions button { flex: 1; }
        }
        @media (max-width: 520px) {
            .bubble { max-width: 100%; }
            .row-actions { justify-content: center; }
        }
        @media (max-width: 360px) {
            #content { padding: clamp(20px, 6vw, 24px) clamp(16px, 5vw, 22px); }
            button.icon { width: 34px; height: 34px; }
        }
        @media (min-width: 768px) {
            :root { --shell-max-width: min(100%, 560px); }
        }
    </style>
</head>
<body class="intro-active">
    <div id="intro">
        <h1>Happy Birthday, Diana<span class="emoji-heart" role="img" aria-label="love">❤️</span></h1>
        <p>"It all began with a simple message under the glow of the northern lights: 'I know we don't know each other, but you're living my dream...' From that unexpected spark, it blossomed into discovering a truly wonderful soul—one I care for deeply, respect immensely, and always strive to stand by, no matter where life takes us. Birthdays aren't just for you; they're a beautiful reminder for those who cherish you, celebrating the joy of being woven into your incredible story."</p>
        <div id="skip-text" onclick="skipIntro()">Tap to skip</div>
    </div>
    <div id="aurora">
        <video id="aurora-video" autoplay loop muted playsinline>
            <source src="

https://cdn-cf-east.streamable.com/video/mp4/46yekd.mp4?Expires=1759238433257&Key-Pair-Id=APKAIEYUVEN4EVB2OKEQ&Signature=RzrhuSTXuLFZayv06DuP552QdiNtFPyMoLeShUnaZxurAjIbRwajLYZAZVN9WCGsjeJq9zHTmQiSUQngLyJyPJBHgyEtLFG1jgIP5Kjhz2-NSzlKBE6xwNLkDAM892rLpCmsLCj~ZpaoGYUysK3gYRc5oPSpWk66du6Vnm9WR1iq97SuTQxFjtP5HYRa6Bl3InLfzJkgTxbsdowtB1SgmuoIvtVBVA5EcWrP855YaWRTjd5tO~ech~v3ybQCODXfu8Xz9Z6bORAYmSXusEoKL~PgrSUE2Ha7IWU-DGXaTKYlxtY7m9oFcHBNTltKkIhUCGQ2iSJSkrYJM8zjGJ28KQ__" type="video/mp4">
        </video>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="constellation"></div>
    </div>
    <div class="app-shell">
        <div id="content">
            <button id="guide-button" class="icon" aria-label="How this works" onclick="openGuide()">?</button>
            <h1>Make a wish<span class="emoji-star" role="img" aria-label="star">⭐</span></h1>
            <p>Under this magical sky, make a wish and receive a reflective insight.</p>
            <div id="initial-controls" class="input-section">
                <div class="wish-field">
                    <input type="text" id="wish-input" placeholder="Type your wish here..." autocomplete="off">
                </div>
                <div class="primary-actions">
                    <button id="submit-btn" class="primary" onclick="processWish()">Submit Wish</button>
                </div>
            </div>
            <div id="response">
                <div id="conversation-track" class="timeline"></div>
                <div id="conversation-body" class="conversation"></div>
            </div>
            <div id="followup-wrapper" class="followup-block" style="display:none;">
                <label for="followup-input">Share the next thought or question guiding you forward:</label>
                <textarea id="followup-input" placeholder="Add a note before we continue..."></textarea>
            </div>
            <div class="action-bar">
                <button id="continue-btn" class="primary" style="display:none;" onclick="continueReflection()">Continue Reflection</button>
                <button id="store-btn" class="primary" style="display:none;" onclick="storeReflection()">Store This Reflection</button>
                <button id="export-btn" class="primary" style="display:none;" onclick="exportConversation()">Download Conversation</button>
                <button id="new-wish-btn" class="ghost" style="display:none;" onclick="startNewWish()">Make a New Wish</button>
                <span id="stored-message">Wish stored!</span>
                <button class="secondary" onclick="viewStored()">View Stored Reflections</button>
            </div>
            <div id="stored-list"></div>
        </div>
    </div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <div id="confirm-overlay" class="modal-overlay" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="confirm-message">
            <p id="confirm-message"></p>
            <div class="modal-actions">
                <button id="confirm-yes" class="confirm-btn">Yes</button>
                <button id="confirm-no" class="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>
    <div id="guide-overlay" class="info-overlay" aria-hidden="true">
        <div class="info-card" role="dialog" aria-modal="true" aria-labelledby="guide-title">
            <button id="guide-close" class="icon close" aria-label="Close guide">&times;</button>
            <h2 id="guide-title">How this space works</h2>
            <ol>
                <li><strong>Make a wish:</strong> share what is on your heart or mind and press <em>Submit Wish</em>.</li>
                <li><strong>Receive a reflection:</strong> read the response, then jot a follow-up thought to continue the dialogue.</li>
                <li><strong>Keep exploring:</strong> add new notes, store meaningful insights, or download the conversation as a keepsake.</li>
                <li><strong>Return anytime:</strong> stored reflections live here so you can revisit or release them whenever you like.</li>
            </ol>
            <p class="footnote">Tip: you can always start a fresh wish with the button beside <em>Submit Wish</em>.</p>
        </div>
    </div>
    <div id="overlay">
        <div id="error-message">
            <p>Oops, the stars aren't aligning right now. Please try again when your connection is stronger-your birthday magic awaits!</p>
            <button onclick="hideError()">Close</button>
        </div>
    </div>
            
        <script>
        (() => {
            const state = { currentWish: null, toastTimer: null, confirmAction: null };

            const id = (value) => document.getElementById(value);
            const qs = (value) => document.querySelector(value);

            const els = {
                overlay: id('overlay'),
                toast: id('toast'),
                storedMessage: id('stored-message'),
                wishInput: id('wish-input'),
                submitBtn: id('submit-btn'),
                followupWrapper: id('followup-wrapper'),
                followupInput: id('followup-input'),
                response: id('response'),
                timeline: id('conversation-track'),
                conversation: id('conversation-body'),
                actionBar: qs('.action-bar'),
                continueBtn: id('continue-btn'),
                storeBtn: id('store-btn'),
                exportBtn: id('export-btn'),
                newWishBtn: id('new-wish-btn'),
                storedList: id('stored-list'),
                initialControls: id('initial-controls'),
                guideOverlay: id('guide-overlay'),
                guideClose: id('guide-close'),
                confirmOverlay: id('confirm-overlay'),
                confirmMessage: id('confirm-message'),
                confirmYes: id('confirm-yes'),
                confirmNo: id('confirm-no'),
            };

            const baseGuidance = "You are Diana's steady inner voice. Respond with sincerity, curiosity, and gentle daring. Keep every reply under 90 words in a single paragraph and end with an original line that feels like a keepsake.";

            function showError() {
                if (els.overlay) els.overlay.style.display = 'flex';
            }

            function hideError() {
                if (els.overlay) els.overlay.style.display = 'none';
            }

            function hideToast() {
                if (!els.toast) return;
                els.toast.classList.remove('show', 'warn', 'error');
                if (state.toastTimer) {
                    clearTimeout(state.toastTimer);
                    state.toastTimer = null;
                }
            }

            function showToast(message, tone = 'info', duration = 2800) {
                if (!els.toast) return;
                hideToast();
                els.toast.className = 'toast';
                if (tone && tone !== 'info') els.toast.classList.add(tone);
                els.toast.textContent = message;
                void els.toast.offsetWidth;
                els.toast.classList.add('show');
                if (duration !== Infinity) {
                    state.toastTimer = window.setTimeout(hideToast, duration);
                }
            }

            function showConfirm(message, onConfirm) {
                if (!(els.confirmOverlay && els.confirmMessage)) {
                    if (typeof onConfirm === 'function') onConfirm();
                    return;
                }
                state.confirmAction = onConfirm;
                els.confirmMessage.textContent = message;
                els.confirmOverlay.classList.add('show');
                els.confirmOverlay.setAttribute('aria-hidden', 'false');
                if (els.confirmYes) els.confirmYes.focus();
            }

            function resolveConfirm(confirmed) {
                if (!els.confirmOverlay) return;
                els.confirmOverlay.classList.remove('show');
                els.confirmOverlay.setAttribute('aria-hidden', 'true');
                const action = state.confirmAction;
                state.confirmAction = null;
                if (confirmed && typeof action === 'function') action();
            }

            function sanitize(value) {
                return String(value || '').replace(/`/g, "'").replace(/\s+/g, ' ').trim();
            }

            function buildInitialPrompt(wish) {
                const cleanWish = sanitize(wish);
                return `${baseGuidance} Evaluate the wish in quotes: "${cleanWish}". If it lacks meaningful content, kindly request more detail in a short paragraph. Otherwise, craft one unique paragraph that mirrors her emotion or ambition, introduces one unexpected lens or question that sharpens her direction, balances realism with hope, and ends with a memorable closing line inviting thoughtful action.`;
            }

            function buildFollowupPrompt(wish, history, note) {
                const cleanWish = sanitize(wish);
                const cleanHistory = (history || []).map((entry) => sanitize(entry));
                const lastReflection = cleanHistory.length ? cleanHistory[cleanHistory.length - 1] : '';
                const earlier = cleanHistory.slice(0, -1).slice(-2);
                const summary = earlier.length ? ' Earlier reflections already offered: ' + earlier.map((text) => `"${text}"`).join(' | ') + '.' : '';
                const cleanNote = sanitize(note);
                return `${baseGuidance} Original wish: "${cleanWish}". Your latest reflection was: "${lastReflection}".${summary} She now adds: "${cleanNote}". Continue the dialogue with another paragraph under 90 words that acknowledges where the last reflection leaves her, offers a fresh angle or probing question, and finishes with a distinct memorable line. If the wish still feels unclear, focus on guiding her to clarify it.`;
            }

            async function callReflectionAPI(prompt) {
                const response = await fetch('/openai-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                if (data && data.error) throw new Error(data.error.message || 'Proxy error');
                const message = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
                return sanitize(message);
            }

            function escapeHtml(str) {
                return String(str || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function formatTimelineForDisplay(timeline) {
                if (!Array.isArray(timeline) || !timeline.length) return '';
                return timeline.map((entry) => {
                    const label = escapeHtml(entry.label || '');
                    const text = escapeHtml(entry.text || '').replace(/\r?\n/g, '<br/>');
                    const type = entry.type || 'note';
                    return `<div class="stored-event ${type}"><strong>${label}</strong><p>${text}</p></div>`;
                }).join('');
            }

            function focusFollowup() {
                if (!els.followupInput || els.followupInput.disabled || els.followupWrapper.style.display === 'none') return;
                window.setTimeout(() => {
                    if (!els.followupInput.disabled) {
                        els.followupInput.focus({ preventScroll: false });
                    }
                }, 200);
            }

            function updateActionVisibility() {
                if (els.storedList && els.storedList.style.display === 'block') {
                    if (els.actionBar) els.actionBar.style.display = 'none';
                    return;
                }
                const current = state.currentWish;
                const hasReflection = !!(current && current.history && current.history.length);
                const waiting = !!(current && current.waiting);

                if (els.initialControls) els.initialControls.style.display = hasReflection ? 'none' : 'flex';
                if (els.actionBar) els.actionBar.style.display = 'flex';
                if (els.followupWrapper) els.followupWrapper.style.display = hasReflection ? 'flex' : 'none';
                if (els.followupInput) {
                    els.followupInput.disabled = !hasReflection || waiting;
                    if (!hasReflection) els.followupInput.value = '';
                }
                if (els.continueBtn) {
                    const noteReady = els.followupInput && els.followupInput.value.trim().replace(/[^a-zA-Z0-9]/g, '').length >= 3;
                    els.continueBtn.style.display = hasReflection ? 'inline-flex' : 'none';
                    els.continueBtn.disabled = !hasReflection || waiting || !noteReady;
                }
                if (els.storeBtn) els.storeBtn.style.display = hasReflection ? 'inline-flex' : 'none';
                if (els.exportBtn) els.exportBtn.style.display = hasReflection ? 'inline-flex' : 'none';
                if (els.newWishBtn) els.newWishBtn.style.display = hasReflection ? 'inline-flex' : 'none';
                if (els.submitBtn) els.submitBtn.disabled = waiting;
            }

            function buildBubble(entry) {
                const bubble = document.createElement('div');
                bubble.className = `bubble ${entry.type || 'note'}`;
                entry.text.split(/\r?\n+/).forEach((paragraph) => {
                    const trimmed = paragraph.trim();
                    if (!trimmed) return;
                    const p = document.createElement('p');
                    p.textContent = trimmed;
                    bubble.appendChild(p);
                });
                return bubble;
            }

            function renderTimeline({ animate = true } = {}) {
                if (!els.response || !els.timeline || !els.conversation) return;
                const current = state.currentWish;
                const hasTimeline = !!(current && Array.isArray(current.timeline) && current.timeline.length);

                els.timeline.innerHTML = '';
                els.conversation.innerHTML = '';

                if (!hasTimeline) {
                    if (current && current.waiting) {
                        els.response.style.display = 'block';
                        els.response.classList.remove('is-visible');
                        els.response.classList.add('is-pending');
                        const thinking = document.createElement('div');
                        thinking.className = 'bubble thinking';
                        thinking.textContent = 'Reflecting on your wish...';
                        els.conversation.appendChild(thinking);
                    } else {
                        els.response.classList.remove('is-visible', 'is-pending');
                        els.response.style.display = 'none';
                    }
                    updateActionVisibility();
                    return;
                }

                current.timeline.forEach((entry, index) => {
                    const crumb = document.createElement('div');
                    crumb.className = `crumb ${entry.type || 'note'}`;
                    crumb.textContent = entry.label || `Step ${index + 1}`;
                    els.timeline.appendChild(crumb);
                    els.conversation.appendChild(buildBubble(entry));
                });

                if (current.waiting) {
                    const thinking = document.createElement('div');
                    thinking.className = 'bubble thinking';
                    thinking.textContent = 'Reflecting on your words...';
                    els.conversation.appendChild(thinking);
                }

                els.response.style.display = 'block';
                if (animate) {
                    els.response.classList.remove('is-visible');
                    void els.response.offsetWidth;
                }
                els.response.classList.remove('is-pending');
                els.response.classList.add('is-visible');

                window.setTimeout(() => {
                    els.conversation.scrollTop = els.conversation.scrollHeight;
                }, 60);

                updateActionVisibility();
                focusFollowup();
            }

            function createTimelineSnapshot(timeline) {
                return Array.isArray(timeline) ? timeline.map((entry) => ({
                    type: entry.type,
                    label: entry.label,
                    text: entry.text
                })) : [];
            }

            async function processWish() {
                const rawWish = els.wishInput ? els.wishInput.value.trim() : '';
                if (!rawWish) {
                    showToast('Share a wish before sending it to the stars.', 'warn');
                    return;
                }
                const minimal = rawWish.replace(/[^a-zA-Z0-9]/g, '');
                if (minimal.length < 3) {
                    showToast('Give a little more detail so the reflection can truly help.', 'warn');
                    return;
                }
                if (els.followupInput) els.followupInput.value = '';
                if (els.submitBtn) els.submitBtn.disabled = true;

                state.currentWish = {
                    wish: rawWish,
                    history: [],
                    timeline: [{ type: 'wish', label: 'Wish', text: rawWish }],
                    waiting: true
                };
                renderTimeline({ animate: false });

                try {
                    const prompt = buildInitialPrompt(rawWish);
                    const reflection = await callReflectionAPI(prompt);
                    if (!reflection) throw new Error('Empty reflection');
                    state.currentWish.history.push(reflection);
                    state.currentWish.timeline.push({ type: 'reflection', label: 'Reflection 1', text: reflection });
                    state.currentWish.waiting = false;
                    renderTimeline({ animate: true });
                } catch (error) {
                    console.error(error);
                    state.currentWish = null;
                    renderTimeline({ animate: false });
                    showError();
                } finally {
                    if (els.submitBtn) els.submitBtn.disabled = false;
                    updateActionVisibility();
                }
            }

            async function continueReflection() {
                if (!state.currentWish || !state.currentWish.history || !state.currentWish.history.length) {
                    showToast('Make a wish first, then we can go deeper.', 'warn');
                    return;
                }
                if (!els.followupInput) return;
                const note = els.followupInput.value.trim();
                if (note.replace(/[^a-zA-Z0-9]/g, '').length < 3) {
                    showToast('Share a little more so we can continue meaningfully.', 'warn');
                    return;
                }

                if (els.continueBtn) els.continueBtn.disabled = true;
                if (els.storeBtn) els.storeBtn.style.display = 'none';

                const noteIndex = state.currentWish.timeline.filter((entry) => entry.type === 'note').length + 1;
                state.currentWish.timeline.push({ type: 'note', label: `Note ${noteIndex}`, text: note });
                state.currentWish.waiting = true;
                renderTimeline({ animate: false });

                try {
                    const prompt = buildFollowupPrompt(state.currentWish.wish, state.currentWish.history, note);
                    const reflection = await callReflectionAPI(prompt);
                    if (!reflection) throw new Error('Empty reflection');
                    state.currentWish.history.push(reflection);
                    state.currentWish.timeline.push({ type: 'reflection', label: `Reflection ${state.currentWish.history.length}`, text: reflection });
                    state.currentWish.waiting = false;
                    if (els.followupInput) els.followupInput.value = '';
                    renderTimeline({ animate: true });
                } catch (error) {
                    console.error(error);
                    state.currentWish.timeline.pop();
                    state.currentWish.waiting = false;
                    renderTimeline({ animate: false });
                    showError();
                } finally {
                    if (els.continueBtn) els.continueBtn.disabled = false;
                    updateActionVisibility();
                }
            }

            function storeReflection() {
                if (!state.currentWish || !state.currentWish.history || !state.currentWish.history.length) return;
                const entry = {
                    wish: state.currentWish.wish,
                    history: state.currentWish.history.slice(),
                    reflection: state.currentWish.history.join(''),
                    timeline: createTimelineSnapshot(state.currentWish.timeline)
                };
                const existing = JSON.parse(localStorage.getItem('reflections') || '[]');
                existing.push(entry);
                localStorage.setItem('reflections', JSON.stringify(existing));
                if (els.storedMessage) {
                    els.storedMessage.classList.add('visible');
                    window.setTimeout(() => els.storedMessage.classList.remove('visible'), 2000);
                }
            }

            function exportConversation() {
                if (!state.currentWish || !state.currentWish.timeline || !state.currentWish.timeline.length) {
                    showToast('There is no conversation to export yet.', 'warn');
                    return;
                }
                const popup = window.open('', '_blank');
                if (!popup) {
                    showToast('Enable pop-ups to download the conversation.', 'error', 3500);
                    return;
                }
                const title = 'Wish Reflection';
                const items = state.currentWish.timeline.map((entry) => {
                    const label = escapeHtml(entry.label || '');
                    const text = escapeHtml(entry.text || '').replace(/\r?\n/g, '<br/>');
                    return `<section class="export-entry ${entry.type}"><h3>${label}</h3><p>${text}</p></section>`;
                }).join('');
                popup.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Georgia,serif;padding:40px;background:#0b1c2a;color:#effff7;}h1{text-align:center;margin-bottom:30px;}section.export-entry{margin-bottom:24px;padding:18px;border-radius:12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.18);}section.export-entry.wish{background:rgba(255,215,0,0.12);}section.export-entry.note{background:rgba(255,140,0,0.12);}section.export-entry.reflection{background:rgba(0,255,200,0.12);}h3{margin:0 0 10px;}p{margin:0;line-height:1.6;}</style></head><body><h1>${escapeHtml(state.currentWish.wish)}</h1>${items}</body></html>`);
                popup.document.close();
                popup.focus();
                popup.print();
            }

            function renderStoredList() {
                if (!els.storedList) return;
                const stored = JSON.parse(localStorage.getItem('reflections') || '[]');
                if (!stored.length) {
                    els.storedList.innerHTML = '<button onclick="backToMain()" style="margin-bottom: 20px;">Back</button><p>No stored reflections yet.</p>';
                    return;
                }
                const items = stored.map((entry, index) => {
                    const wish = escapeHtml(entry && entry.wish ? entry.wish : '');
                    const preview = entry && entry.timeline && entry.timeline.length
                        ? formatTimelineForDisplay(entry.timeline)
                        : formatTimelineForDisplay([
                            { type: 'wish', label: 'Wish', text: entry.wish },
                            { type: 'reflection', label: 'Reflection', text: entry.reflection }
                        ]);
                    return `<li><strong>Wish:</strong> ${wish}<div class="conversation-preview">${preview}</div><div class="row-actions"><button class="delete-btn" onclick="deleteReflection(${index})">Delete</button></div></li>`;
                }).join('');
                els.storedList.innerHTML = `<button onclick="backToMain()" style="margin-bottom: 20px;">Back</button><ul>${items}</ul>`;
            }

            function viewStored() {
                if (!els.storedList) return;
                els.storedList.style.display = 'block';
                if (els.response) els.response.style.display = 'none';
                if (els.followupWrapper) els.followupWrapper.style.display = 'none';
                if (els.actionBar) els.actionBar.style.display = 'none';
                if (els.initialControls) els.initialControls.style.display = 'none';
                renderStoredList();
            }

            function deleteReflection(index) {
                showConfirm('Delete this reflection? The insight will be lost to the night.', () => {
                    const stored = JSON.parse(localStorage.getItem('reflections') || '[]');
                    if (index < 0 || index >= stored.length) return;
                    stored.splice(index, 1);
                    localStorage.setItem('reflections', JSON.stringify(stored));
                    renderStoredList();
                });
            }

            function startNewWish() {
                state.currentWish = null;
                if (els.wishInput) {
                    els.wishInput.value = '';
                    els.wishInput.focus();
                }
                if (els.followupInput) els.followupInput.value = '';
                renderTimeline({ animate: false });
                updateActionVisibility();
            }

            function backToMain() {
                if (els.storedList) els.storedList.style.display = 'none';
                if (els.actionBar) els.actionBar.style.display = 'flex';
                renderTimeline({ animate: false });
            }

            function openGuide() {
                if (!els.guideOverlay) return;
                els.guideOverlay.classList.add('show');
                els.guideOverlay.setAttribute('aria-hidden', 'false');
            }

            function closeGuide() {
                if (!els.guideOverlay) return;
                els.guideOverlay.classList.remove('show');
                els.guideOverlay.setAttribute('aria-hidden', 'true');
            }

            function skipIntro() {
                const intro = document.getElementById('intro');
                if (!intro) return;
                intro.classList.add('hidden');
                document.body.classList.remove('intro-active');
            }

            if (els.confirmYes) els.confirmYes.addEventListener('click', () => resolveConfirm(true));
            if (els.confirmNo) els.confirmNo.addEventListener('click', () => resolveConfirm(false));
            if (els.confirmOverlay) els.confirmOverlay.addEventListener('click', (event) => {
                if (event.target === els.confirmOverlay) resolveConfirm(false);
            });
            window.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && els.confirmOverlay && els.confirmOverlay.classList.contains('show')) {
                    resolveConfirm(false);
                }
            });

            if (els.followupInput) els.followupInput.addEventListener('input', updateActionVisibility);
            if (els.guideOverlay) els.guideOverlay.addEventListener('click', (event) => {
                if (event.target === els.guideOverlay) closeGuide();
            });
            if (els.guideClose) els.guideClose.addEventListener('click', closeGuide);

            const intro = document.getElementById('intro');
            if (intro) {
                document.body.classList.add('intro-active');
                intro.addEventListener('touchstart', skipIntro);
                intro.addEventListener('click', skipIntro);
                window.setTimeout(skipIntro, 50000);
            }

            backToMain();
            updateActionVisibility();

            window.processWish = processWish;
            window.continueReflection = continueReflection;
            window.storeReflection = storeReflection;
            window.exportConversation = exportConversation;
            window.viewStored = viewStored;
            window.deleteReflection = deleteReflection;
            window.startNewWish = startNewWish;
            window.openGuide = openGuide;
            window.skipIntro = skipIntro;
            window.closeGuide = closeGuide;
            window.hideError = hideError;
            window.showError = showError;
            window.backToMain = backToMain;
        })();
        </script>


</body>

</html>


