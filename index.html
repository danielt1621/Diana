<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Birthday Reflection</title>
    <style>
        :root {
            --bg: #02060f;
            --bg-glow: radial-gradient(circle at 20% 20%, rgba(52, 241, 197, 0.18), transparent 55%), radial-gradient(circle at 80% 10%, rgba(255, 214, 109, 0.2), transparent 60%);
            --panel: rgba(6, 20, 34, 0.82);
            --panel-strong: rgba(8, 24, 40, 0.92);
            --panel-soft: rgba(8, 24, 40, 0.7);
            --text: #f4feff;
            --muted: rgba(244, 254, 255, 0.75);
            --accent: #34f1c5;
            --accent-soft: rgba(52, 241, 197, 0.35);
            --accent-strong: rgba(52, 241, 197, 0.75);
            --gold: #ffd66d;
            --danger: #ff6b6b;
            --radius-lg: clamp(18px, 6vw, 32px);
            --radius-md: clamp(12px, 5vw, 22px);
            --radius-sm: clamp(8px, 4vw, 16px);
            --gap-lg: clamp(22px, 6vw, 34px);
            --gap-md: clamp(16px, 5vw, 24px);
            --gap-sm: clamp(10px, 4vw, 18px);
            --shadow-soft: 0 30px 60px rgba(0, 0, 0, 0.45);
            color-scheme: dark;
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }
        html {
            height: 100%;
        }
        body {
            margin: 0;
            min-height: 100dvh;
            height: 100%;
            background: var(--bg);
            background-image: var(--bg-glow);
            color: var(--text);
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: calc(18px + env(safe-area-inset-top, 0px)) clamp(12px, 5vw, 36px) calc(26px + env(safe-area-inset-bottom, 0px));
            overflow: hidden;
            position: relative;
            -webkit-text-size-adjust: 100%;
        }
        body.chat-open {
            overflow: hidden;
        }
        #sky {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }
        #sky::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(2, 6, 15, 0.25), rgba(2, 6, 15, 0.65));
        }
        #sky video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.82) saturation(1.05);
        }
        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            opacity: 0.7;
            animation: twinkle 4s ease-in-out infinite;
        }
        .star:nth-child(1) { top: 8%; left: 18%; width: 2px; height: 2px; animation-delay: 0.2s; }
        .star:nth-child(2) { top: 15%; left: 68%; width: 3px; height: 3px; animation-delay: 1s; }
        .star:nth-child(3) { top: 28%; left: 42%; width: 2px; height: 2px; animation-delay: 1.8s; }
        .star:nth-child(4) { top: 42%; left: 82%; width: 1px; height: 1px; animation-delay: 0.6s; }
        .star:nth-child(5) { top: 65%; left: 55%; width: 2px; height: 2px; animation-delay: 1.4s; }
        .star:nth-child(6) { top: 72%; left: 18%; width: 3px; height: 3px; animation-delay: 2.1s; }
        #app {
            position: relative;
            z-index: 2;
            width: min(100%, 780px);
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            gap: var(--gap-lg);
            padding: clamp(20px, 6vw, 36px);
            border-radius: var(--radius-lg);
            background: var(--panel);
            backdrop-filter: blur(18px);
            box-shadow: var(--shadow-soft);
            max-height: calc(100dvh - calc(env(safe-area-inset-top, 0px) + env(safe-area-inset-bottom, 0px)) - clamp(46px, 12vw, 120px));
            overflow: hidden;
        }
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--gap-sm);
        }
        .brand {
            text-align: left;
        }
        .brand h1 {
            margin: 0;
            font-size: clamp(1.8rem, 1.3rem + 1.4vw, 2.4rem);
            letter-spacing: 0.04em;
            display: flex;
            align-items: center;
            gap: 0.4em;
        }
        .emoji-star {
            display: inline-block;
            animation: shimmer 3s ease-in-out infinite;
            filter: drop-shadow(0 0 8px rgba(255, 214, 109, 0.45));
        }
        .emoji-heart {
            display: inline-block;
            animation: heartbeat 1.6s ease-in-out infinite;
            transform-origin: center;
            filter: drop-shadow(0 0 6px rgba(255, 88, 150, 0.45));
        }
        button.icon-button {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 1px solid rgba(244, 254, 255, 0.25);
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        button.icon-button:hover,
        button.icon-button:focus-visible {
            transform: translateY(-1px);
            border-color: var(--accent);
            box-shadow: 0 0 14px rgba(52, 241, 197, 0.3);
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .screen {
            display: none;
            flex: 1;
            overflow: hidden;
        }
        .screen.is-active {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
            overflow-y: auto;
            padding-right: 4px;
        }
        .screen::-webkit-scrollbar {
            width: 6px;
        }
        .screen::-webkit-scrollbar-thumb {
            background: rgba(244, 254, 255, 0.25);
            border-radius: 999px;
        }
        #screen-menu {
            align-items: center;
            text-align: center;
            justify-content: center;
            padding-bottom: clamp(12px, 4vw, 20px);
        }
        #screen-menu h2 {
            font-size: clamp(1.6rem, 1.1rem + 1.6vw, 2.1rem);
            margin: 0;
        }
        #screen-menu p {
            margin: 8px 0 24px;
            color: var(--muted);
            max-width: 38ch;
        }
        .menu-actions {
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
            width: min(420px, 100%);
        }
        .menu-actions button {
            width: 100%;
        }
        button.primary,
        button.secondary,
        button.ghost {
            appearance: none;
            border: none;
            border-radius: 999px;
            padding: 14px 20px;
            font-size: clamp(1rem, 0.6rem + 1vw, 1.1rem);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        }
        button.primary {
            background: linear-gradient(135deg, rgba(52, 241, 197, 0.95), rgba(30, 170, 192, 0.88));
            color: #001216;
            box-shadow: 0 12px 30px rgba(52, 241, 197, 0.35);
        }
        button.primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        button.primary:not(:disabled):hover,
        button.primary:not(:disabled):focus-visible {
            transform: translateY(-1px);
            box-shadow: 0 16px 38px rgba(52, 241, 197, 0.45);
        }
        button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border: 1px solid rgba(244, 254, 255, 0.24);
        }
        button.secondary:hover,
        button.secondary:focus-visible {
            border-color: var(--accent);
            box-shadow: 0 0 16px rgba(52, 241, 197, 0.28);
        }
        button.ghost {
            background: transparent;
            color: var(--text);
            border: 1px solid rgba(244, 254, 255, 0.2);
        }
        button.ghost:hover,
        button.ghost:focus-visible {
            border-color: var(--gold);
            color: var(--gold);
            box-shadow: 0 0 16px rgba(255, 214, 109, 0.28);
        }
        #screen-saved {
            gap: var(--gap-md);
        }
        .saved-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--gap-sm);
        }
        .saved-header h2 {
            margin: 0;
            font-size: clamp(1.4rem, 1rem + 1vw, 1.9rem);
        }
        .saved-header p {
            margin: 4px 0 0;
            color: var(--muted);
        }
        #saved-list {
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .saved-empty {
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
            text-align: left;
            background: var(--panel-strong);
            border-radius: var(--radius-md);
            padding: clamp(18px, 4vw, 24px);
            border: 1px solid rgba(244, 254, 255, 0.12);
        }
        .saved-card {
            background: var(--panel-strong);
            border-radius: var(--radius-md);
            padding: clamp(18px, 4vw, 26px);
            border: 1px solid rgba(244, 254, 255, 0.14);
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .saved-card.is-current {
            border-color: var(--accent);
            box-shadow: 0 12px 28px rgba(52, 241, 197, 0.25);
        }
        .saved-card header {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .saved-card h3 {
            margin: 0;
            font-size: clamp(1.1rem, 0.8rem + 0.9vw, 1.4rem);
        }
        .saved-card p {
            margin: 0;
            color: var(--muted);
            font-size: 0.95rem;
        }
        .saved-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            color: rgba(244, 254, 255, 0.65);
            font-size: 0.85rem;
        }
        .saved-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .saved-actions button {
            flex: 1 1 45%;
        }
        .saved-actions button.delete {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.85), rgba(214, 60, 94, 0.9));
            color: #1b0202;
            border: none;
        }
        .saved-actions button.delete:hover,
        .saved-actions button.delete:focus-visible {
            box-shadow: 0 12px 26px rgba(255, 107, 107, 0.4);
        }
        #screen-chat {
            position: fixed;
            inset: 0;
            padding: calc(18px + env(safe-area-inset-top, 0px)) clamp(12px, 3vw, 24px) calc(20px + env(safe-area-inset-bottom, 0px));
            display: none;
            flex-direction: column;
            background: rgba(2, 6, 15, 0.82);
            backdrop-filter: blur(20px);
            z-index: 50;
        }
        #screen-chat.is-active {
            display: flex;
        }
        .chat-shell {
            flex: 1;
            max-width: min(760px, 100%);
            margin: 0 auto;
            background: var(--panel-strong);
            border-radius: clamp(18px, 5vw, 30px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(244, 254, 255, 0.1);
            box-shadow: var(--shadow-soft);
        }
        .chat-header {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
            padding: clamp(14px, 4vw, 22px);
            border-bottom: 1px solid rgba(244, 254, 255, 0.12);
        }
        .chat-header button {
            flex-shrink: 0;
        }
        .chat-titles {
            flex: 1;
            min-width: 0;
        }
        .chat-titles h2 {
            margin: 0;
            font-size: clamp(1.2rem, 0.9rem + 1vw, 1.6rem);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-titles p {
            margin: 4px 0 0;
            color: var(--muted);
            font-size: 0.95rem;
        }
        .chat-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #chat-thread {
            flex: 1;
            overflow-y: auto;
            padding: clamp(18px, 4vw, 26px);
            display: flex;
            flex-direction: column;
            gap: clamp(12px, 3vw, 18px);
            scroll-padding-bottom: 80px;
        }
        #chat-thread::-webkit-scrollbar {
            width: 6px;
        }
        #chat-thread::-webkit-scrollbar-thumb {
            background: rgba(244, 254, 255, 0.18);
            border-radius: 999px;
        }
        .bubble {
            max-width: min(88%, 480px);
            padding: clamp(12px, 3.5vw, 18px);
            border-radius: clamp(16px, 5vw, 26px);
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(244, 254, 255, 0.12);
            color: var(--text);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 18px 38px rgba(0, 0, 0, 0.35);
            animation: fadeSlide 0.4s ease;
        }
        .bubble.incoming {
            animation: bubbleReveal 0.45s ease;
            box-shadow: 0 20px 44px rgba(52, 241, 197, 0.22);
        }
        .bubble.user {
            align-self: flex-end;
            background: linear-gradient(135deg, rgba(255, 214, 109, 0.22), rgba(0, 0, 0, 0.5));
            border-color: rgba(255, 214, 109, 0.4);
            text-align: right;
        }
        .bubble.guide {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(52, 241, 197, 0.16), rgba(0, 0, 0, 0.44));
            border-color: rgba(52, 241, 197, 0.32);
        }
        .bubble .meta {
            font-size: 0.78rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: rgba(244, 254, 255, 0.6);
        }
        .bubble p {
            margin: 0;
            line-height: 1.55;
            word-break: break-word;
        }
        .bubble.thinking {
            align-self: flex-start;
            background: rgba(244, 254, 255, 0.1);
            border-color: rgba(244, 254, 255, 0.22);
            color: var(--muted);
        }
        .bubble.thinking p {
            margin-bottom: 6px;
        }
        .bubble.thinking .typing-dots {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            margin-top: 2px;
        }
        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(244, 254, 255, 0.78);
            animation: dotBounce 1.2s ease-in-out infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.15s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.3s; }
        .chat-footer {
            padding: clamp(16px, 4vw, 24px);
            background: rgba(0, 0, 0, 0.28);
            border-top: 1px solid rgba(244, 254, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
        }
        #chat-input {
            width: 100%;
            min-height: 56px;
            max-height: 180px;
            resize: none;
            border-radius: var(--radius-md);
            border: 1px solid rgba(244, 254, 255, 0.18);
            background: rgba(0, 0, 0, 0.38);
            color: var(--text);
            font-size: 1.05rem;
            padding: 14px 16px;
            line-height: 1.4;
        }
        #chat-input:focus-visible {
            outline: 2px solid var(--accent-soft);
            outline-offset: 2px;
        }
        #chat-input::placeholder {
            color: rgba(244, 254, 255, 0.45);
        }
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        .chat-actions button {
            flex: 1;
        }
        .chat-actions button:first-child {
            flex: 0 0 120px;
        }
        .toast {
            position: fixed;
            bottom: calc(16px + env(safe-area-inset-bottom, 0px));
            left: 50%;
            transform: translateX(-50%) translateY(120%);
            background: rgba(8, 24, 40, 0.9);
            color: var(--text);
            border-radius: 999px;
            padding: 12px 20px;
            font-size: 0.95rem;
            z-index: 80;
            transition: transform 0.35s ease;
            box-shadow: 0 16px 34px rgba(0, 0, 0, 0.35);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        .toast.warn {
            color: var(--gold);
        }
        .toast.error {
            color: var(--danger);
        }
        .overlay-sheet {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(2, 6, 15, 0.78);
            backdrop-filter: blur(18px);
            z-index: 60;
            padding: clamp(20px, 6vw, 32px);
        }
        .overlay-sheet.is-active {
            display: flex;
        }
        .info-card {
            background: var(--panel-strong);
            border-radius: var(--radius-lg);
            padding: clamp(24px, 5vw, 36px);
            width: min(92vw, 520px);
            border: 1px solid rgba(244, 254, 255, 0.18);
            box-shadow: var(--shadow-soft);
            text-align: left;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
            animation: floatUp 0.45s ease;
        }
        .info-card h2 {
            margin: 0;
            text-align: center;
            font-size: clamp(1.4rem, 1rem + 1vw, 1.9rem);
        }
        .info-card ol {
            margin: 0;
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .info-card .footnote {
            text-align: center;
            color: var(--muted);
            font-size: 0.9rem;
        }
        .info-card button.icon-button {
            position: absolute;
            top: 14px;
            right: 14px;
        }
        .confirm-card {
            background: var(--panel-strong);
            border-radius: var(--radius-md);
            padding: clamp(22px, 5vw, 30px);
            width: min(90vw, 420px);
            border: 1px solid rgba(244, 254, 255, 0.16);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
            animation: floatUp 0.35s ease;
        }
        .confirm-card p {
            margin: 0;
            color: var(--text);
            text-align: center;
        }
        .confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .confirm-actions button {
            flex: 1;
        }
        .confirm-actions .danger {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.92), rgba(214, 60, 94, 0.95));
            color: #1b0202;
        }
        #intro {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(24px, 8vw, 42px);
            background: transparent;
            backdrop-filter: blur(6px);
            z-index: 90;
            transition: opacity 0.6s ease;
            overflow: hidden;
        }
        #intro::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(2, 6, 15, 0.35), rgba(2, 6, 15, 0.72));
            backdrop-filter: blur(2px);
            z-index: 0;
            pointer-events: none;
        }
        #intro.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .intro-card {
            position: relative;
            z-index: 1;
            background: rgba(6, 24, 38, 0.78);
            border-radius: var(--radius-lg);
            padding: clamp(28px, 8vw, 40px);
            border: 1px solid rgba(244, 254, 255, 0.16);
            box-shadow: var(--shadow-soft);
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
            max-width: 720px;
            width: min(92vw, 720px);
            max-height: none;
            overflow: visible;
        }
        .intro-card h1 {
            margin: 0;
            font-family: 'Georgia', serif;
            font-size: clamp(2rem, 1.4rem + 2vw, 2.8rem);
            line-height: 1.2;
            animation: fadeIntroTitle 1.4s ease both;
        }
        .intro-card p {
            margin: 0;
            font-size: clamp(1.05rem, 0.9rem + 0.9vw, 1.3rem);
            color: var(--muted);
            text-wrap: pretty;
            line-height: 1.65;
            opacity: 0;
            animation: fadeIntroBody 1.2s ease 0.35s forwards;
        }
        #intro-skip {
            align-self: center;
            padding: 12px 28px;
            border-radius: 999px;
            border: 1px solid rgba(255, 214, 109, 0.55);
            background: rgba(255, 214, 109, 0.15);
            color: var(--gold);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: sticky;
            bottom: 0;
        }
        #intro-skip:hover,
        #intro-skip:focus-visible {
            transform: translateY(-1px);
            box-shadow: 0 0 16px rgba(255, 214, 109, 0.4);
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.18); }
            45% { transform: scale(0.96); }
            65% { transform: scale(1.08); }
            80% { transform: scale(1.02); }
        }
        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); opacity: 0.85; }
            40% { transform: rotate(8deg); opacity: 1; }
            60% { transform: rotate(-6deg); opacity: 0.95; }
        }
        @keyframes fadeIntroTitle {
            0% { opacity: 0; transform: translateY(18px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes fadeIntroBody {
            0% { opacity: 0; transform: translateY(16px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes dotBounce {
            0%, 100% { transform: translateY(0); opacity: 0.4; }
            50% { transform: translateY(-6px); opacity: 1; }
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.45; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bubbleReveal {\r\n            0% { opacity: 0; transform: translateY(14px) scale(0.97); }\r\n            60% { opacity: 0.9; transform: translateY(-2px) scale(1.01); }\r\n            100% { opacity: 1; transform: translateY(0) scale(1); }\r\n        }\r\n        @keyframes floatUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #orientation-warning {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: clamp(32px, 8vw, 48px);
            background: rgba(2, 6, 15, 0.9);
            color: var(--text);
            z-index: 110;
            backdrop-filter: blur(18px);
        }
        #orientation-warning p {
            max-width: 32ch;
            line-height: 1.6;
            font-size: clamp(1.05rem, 0.9rem + 0.8vw, 1.25rem);
        }
        @media screen and (orientation: landscape) and (max-width: 900px) {
            #orientation-warning {
                display: flex;
            }
        }
        @media (min-width: 680px) {
            body {
                padding-left: clamp(24px, 6vw, 72px);
                padding-right: clamp(24px, 6vw, 72px);
            }
            #app {
                max-height: min(calc(100dvh - calc(env(safe-area-inset-top, 0px) + env(safe-area-inset-bottom, 0px)) - 64px), 760px);
            }
            .chat-actions button:first-child {
                flex: 0 0 160px;
            }
            .saved-actions button {
                flex: 0 0 auto;
            }
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body class="is-intro">
    <div id="sky" aria-hidden="true">
        <video autoplay loop muted playsinline>
            <source src="https://cdn-cf-east.streamable.com/video/mp4/46yekd.mp4?Expires=1759238433257&Key-Pair-Id=APKAIEYUVEN4EVB2OKEQ&Signature=RzrhuSTXuLFZayv06DuP552QdiNtFPyMoLeShUnaZxurAjIbRwajLYZAZVN9WCGsjeJq9zHTmQiSUQngLyJyPJBHgyEtLFG1jgIP5Kjhz2-NSzlKBE6xwNLkDAM892rLpCmsLCj~ZpaoGYUysK3gYRc5oPSpWk66du6Vnm9WR1iq97SuTQxFjtP5HYRa6Bl3InLfzJkgTxbsdowtB1SgmuoIvtVBVA5EcWrP855YaWRTjd5tO~ech~v3ybQCODXfu8Xz9Z6bORAYmSXusEoKL~PgrSUE2Ha7IWU-DGXaTKYlxtY7m9oFcHBNTltKkIhUCGQ2iSJSkrYJM8zjGJ28KQ__" type="video/mp4">
        </video>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>
    <main id="app" role="presentation">
        <header class="app-header">
            <div class="brand">
                <h1>Make a wish<span aria-hidden="true" class="emoji-star">&#9733;</span></h1>
            </div>
        </header>

        <section id="screen-menu" class="screen is-active" role="region" aria-labelledby="menu-heading">
            <h2 id="menu-heading">Where shall we wander?</h2>
            <p>Select an adventure to begin, or revisit keepsakes gathered before.</p>
            <div class="menu-actions">
                <button id="menu-start" class="primary" type="button">Make a wish</button>
                <button id="menu-saved" class="secondary" type="button">Saved wishes</button>
                <button id="menu-info" class="ghost" type="button">How this works</button>
            </div>
        </section>

        <section id="screen-saved" class="screen" role="region" aria-labelledby="saved-heading" aria-hidden="true">
            <div class="saved-header">
                <div>
                    <h2 id="saved-heading">Saved wishes</h2>
                    <p>Continue a story, download a keepsake, or let one drift away.</p>
                </div>
                <button id="saved-back" class="icon-button" type="button" aria-label="Back to menu">&larr;</button>
            </div>
            <ul id="saved-list" aria-live="polite"></ul>
        </section>
    </main>

    <section id="screen-chat" class="" role="dialog" aria-modal="true" aria-labelledby="chat-title" aria-hidden="true">
        <div class="chat-shell">
            <header class="chat-header">
                <button id="chat-close" class="icon-button" type="button" aria-label="Back to menu">&larr;</button>
                <div class="chat-titles">
                    <h2 id="chat-title">New wish</h2>
                    <p id="chat-subtitle">Share your wish to begin the conversation.</p>
                </div>
                <button id="chat-save" class="secondary" type="button" disabled>Save</button>
            </header>
            <div class="chat-body">
                <div id="chat-thread" role="log" aria-live="polite"></div>
                <div class="chat-footer">
                    <label for="chat-input" class="sr-only" hidden>Message</label>
                    <textarea id="chat-input" name="message" placeholder="Share your wish..." rows="2"></textarea>
                    <div class="chat-actions">
                        <button id="chat-reset" class="ghost" type="button" disabled>Start over</button>
                        <button id="chat-send" class="primary" type="button">Send wish</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="info-sheet" class="overlay-sheet" role="dialog" aria-modal="true" aria-labelledby="info-title" aria-hidden="true">
        <article class="info-card">
            <button id="info-close" class="icon-button" type="button" aria-label="Close guide">&times;</button>
            <h2 id="info-title">How this space works</h2>
            <ol>
                <li><strong>Make a wish:</strong> share what is on your heart and press <em>Send wish</em> to invite a reflection.</li>
                <li><strong>Keep the dialogue flowing:</strong> add thoughts whenever you like and let Reflection respond in the same thread.</li>
                <li><strong>Save or return:</strong> capture the conversation, download it, or reopen it whenever inspiration strikes.</li>
                <li><strong>Stay present:</strong> every reply is written for her, in the moment, under this shared sky.</li>
            </ol>
            <p class="footnote">Tip: when you reopen a saved wish, new reflections will continue within the same story.</p>
        </article>
    </div>

    <div id="confirm-sheet" class="overlay-sheet" role="dialog" aria-modal="true" aria-labelledby="confirm-message" aria-hidden="true">
        <div class="confirm-card">
            <p id="confirm-message">Are you sure?</p>
            <div class="confirm-actions">
                <button id="confirm-yes" class="danger primary" type="button">Yes</button>
                <button id="confirm-no" class="ghost" type="button">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <div id="intro" role="dialog" aria-modal="true" aria-labelledby="intro-title">
        <div class="intro-card">
            <h1 id="intro-title">Happy Birthday, Diana <span aria-hidden="true" class="emoji-heart">&#10084;</span></h1>
            <p>"It all began with a simple message under the glow of the northern lights: 'I know we don't know each other, but you're living my dream...' From that unexpected spark, it blossomed into discovering a truly wonderful soul&mdash;one cared for deeply, respected immensely, and cherished no matter where life flows. Birthdays aren't just for you; they're a reminder to those who adore you that your story is magic worth celebrating."</p>
            <button id="intro-skip" type="button">Tap to begin</button>
        </div>
    </div>

    <div id="orientation-warning" aria-hidden="true">
        <p>Please rotate your device back to portrait to keep the aurora glowing.</p>
    </div>
    <script>
        (() => {
            const storeKey = 'reflections';
            const baseGuidance = "You are Reflection, a thoughtful guide for Diana's birthday wishes. Reply as \"Reflection\" with sincerity, curiosity, and gentle daring. Keep every reply under 90 words in a single paragraph, end with an original keepsake line, and if her note drifts away from heartfelt wishes gently remind her this space is for wishes and invite her to share one.";
            const state = {
                saved: [],
                current: null,
                toastTimer: null,
                confirmHandler: null
            };

            const els = {
                body: document.body,
                app: document.getElementById('app'),
                screenMenu: document.getElementById('screen-menu'),
                screenSaved: document.getElementById('screen-saved'),
                screenChat: document.getElementById('screen-chat'),
                intro: document.getElementById('intro'),
                introSkip: document.getElementById('intro-skip'),
                menuStart: document.getElementById('menu-start'),
                menuSaved: document.getElementById('menu-saved'),
                menuInfo: document.getElementById('menu-info'),
                infoSheet: document.getElementById('info-sheet'),
                infoClose: document.getElementById('info-close'),
                savedBack: document.getElementById('saved-back'),
                savedList: document.getElementById('saved-list'),
                toast: document.getElementById('toast'),
                confirmSheet: document.getElementById('confirm-sheet'),
                confirmMessage: document.getElementById('confirm-message'),
                confirmYes: document.getElementById('confirm-yes'),
                confirmNo: document.getElementById('confirm-no'),
                chatTitle: document.getElementById('chat-title'),
                chatSubtitle: document.getElementById('chat-subtitle'),
                chatThread: document.getElementById('chat-thread'),
                chatInput: document.getElementById('chat-input'),
                chatSend: document.getElementById('chat-send'),
                chatSave: document.getElementById('chat-save'),
                chatReset: document.getElementById('chat-reset'),
                chatClose: document.getElementById('chat-close')
            };

            const screens = {
                menu: els.screenMenu,
                saved: els.screenSaved
            };

            const safeString = (value) => String(value == null ? '' : value);
            const sanitize = (value) => safeString(value).replace(/`/g, "'").replace(/\s+/g, ' ').trim();

            const cloneConversation = (entry) => ({
                id: entry.id,
                wish: entry.wish || '',
                messages: entry.messages ? entry.messages.map((message) => ({
                    id: message.id || generateId('msg'),
                    author: message.author === 'guide' ? 'guide' : 'user',
                text: safeString(message.text).trim(),
                    createdAt: Number.isFinite(message.createdAt) ? message.createdAt : Date.now()
                })) : [],
                history: entry.history ? entry.history.slice() : deriveHistory(entry.messages),
                justReceived: null,
                createdAt: Number.isFinite(entry.createdAt) ? entry.createdAt : Date.now(),
                updatedAt: Number.isFinite(entry.updatedAt) ? entry.updatedAt : Date.now(),
                waiting: false,
                dirty: false
            });
            function deriveHistory(messages) {
                if (!Array.isArray(messages)) return [];
                return messages.filter((msg) => msg && msg.author === 'guide').map((msg) => safeString(msg.text).trim()).filter(Boolean);
            }

            function generateId(prefix = 'id') {
                if (window.crypto && crypto.randomUUID) {
                    return `${prefix}-${crypto.randomUUID()}`;
                }
                return `${prefix}-${Date.now()}-${Math.floor(Math.random() * 1e6)}`;
            }

            function showToast(message, tone = 'info', duration = 2800) {
                if (!els.toast) return;
                clearTimeout(state.toastTimer);
                els.toast.textContent = message;
                els.toast.className = 'toast';
                if (tone !== 'info') els.toast.classList.add(tone);
                requestAnimationFrame(() => els.toast.classList.add('show'));
                if (duration !== Infinity) {
                    state.toastTimer = window.setTimeout(() => els.toast.classList.remove('show'), duration);
                }
            }

            function hideToast() {
                clearTimeout(state.toastTimer);
                if (els.toast) els.toast.classList.remove('show');
            }

            function openConfirm(message, handler) {
                if (!els.confirmSheet) return handler && handler(false);
                state.confirmHandler = handler || null;
                els.confirmMessage.textContent = message;
                els.confirmSheet.classList.add('is-active');
                els.confirmSheet.setAttribute('aria-hidden', 'false');
                window.setTimeout(() => {
                    if (els.confirmYes) els.confirmYes.focus();
                }, 60);
            }

            function closeConfirm(result = false) {
                if (!els.confirmSheet) return;
                els.confirmSheet.classList.remove('is-active');
                els.confirmSheet.setAttribute('aria-hidden', 'true');
                const handler = state.confirmHandler;
                state.confirmHandler = null;
                if (typeof handler === 'function') handler(result);
            }

            function showInfo() {
                if (!els.infoSheet) return;
                els.infoSheet.classList.add('is-active');
                els.infoSheet.setAttribute('aria-hidden', 'false');
                window.setTimeout(() => {
                    if (els.infoClose) els.infoClose.focus();
                }, 60);
            }

            function hideInfo() {
                if (!els.infoSheet) return;
                els.infoSheet.classList.remove('is-active');
                els.infoSheet.setAttribute('aria-hidden', 'true');
            }

            function hideIntro() {
                if (!els.intro) return;
                els.intro.classList.add('hidden');
                els.intro.setAttribute('aria-hidden', 'true');
                els.body.classList.remove('is-intro');
                window.setTimeout(() => {
                    if (els.intro && els.intro.parentElement) {
                        els.intro.parentElement.removeChild(els.intro);
                    }
                }, 650);
            }

            function switchScreen(name) {
                Object.entries(screens).forEach(([key, screen]) => {
                    if (!screen) return;
                    const active = key === name;
                    screen.classList.toggle('is-active', active);
                    screen.setAttribute('aria-hidden', active ? 'false' : 'true');
                });
            }

            function showMenu() {
                switchScreen('menu');
            }

            function showSaved() {
                switchScreen('saved');
            }

            function openChat(entry = null) {
                if (entry) {
                    state.current = cloneConversation(entry);
                    state.current.dirty = false;
                    state.current.history = deriveHistory(state.current.messages);
                } else {
                    startFreshConversation();
                }
                renderChat(true);
                els.screenChat.classList.add('is-active');
                els.screenChat.setAttribute('aria-hidden', 'false');
                els.body.classList.add('chat-open');
                window.setTimeout(() => {
                    if (els.chatInput) {
                        els.chatInput.focus({ preventScroll: false });
                    }
                }, 120);
            }

            function closeChat(goToMenu = true) {
                if (!els.screenChat.classList.contains('is-active')) return;
                els.screenChat.classList.remove('is-active');
                els.screenChat.setAttribute('aria-hidden', 'true');
                els.body.classList.remove('chat-open');
                if (goToMenu) showMenu();
            }

            function startFreshConversation() {
                state.current = {
                    id: null,
                    wish: '',
                    messages: [],
                    history: [],
                    justReceived: null,
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    waiting: false,
                    dirty: false
                };
            }

            function renderChat(scrollToEnd = false) {
                if (!els.chatThread) return;
                els.chatThread.innerHTML = '';
                if (!state.current) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'bubble thinking';
                    const paragraph = document.createElement('p');
                    paragraph.textContent = 'Ready when you are, Diana. Share a wish and Reflection will meet you there.';
                    placeholder.appendChild(paragraph);
                    els.chatThread.appendChild(placeholder);
                    updateChatHeader();
                    updateChatControls();
                    return;
                }

                const highlightId = state.current ? state.current.justReceived : null;
                let highlightBubble = null;
                const fragment = document.createDocumentFragment();
                state.current.messages.forEach((message) => {
                    const bubble = document.createElement('article');
                    bubble.className = 'bubble ' + (message.author === 'guide' ? 'guide' : 'user');
                    bubble.dataset.messageId = message.id;

                    const label = document.createElement('span');
                    label.className = 'meta';
                    label.textContent = message.author === 'guide' ? 'Reflection' : 'Diana';
                    bubble.appendChild(label);

                    message.text.split(/\r?\n+/).forEach((line) => {
                        if (!line.trim()) return;
                        const paragraph = document.createElement('p');
                        paragraph.textContent = line.trim();
                        bubble.appendChild(paragraph);
                    });

                    if (highlightId && message.id === highlightId && message.author === 'guide') {
                        bubble.classList.add('incoming');
                        highlightBubble = bubble;
                    }

                    fragment.appendChild(bubble);
                });

                if (state.current.waiting) {
                    fragment.appendChild(createThinkingBubble());
                }

                if (!state.current.messages.length && !state.current.waiting) {
                    const nudge = document.createElement('article');
                    nudge.className = 'bubble thinking';
                    const text = document.createElement('p');
                    text.textContent = 'Start with anything on your heart - a hope, a plan, or even a whisper of a dream.';
                    nudge.appendChild(text);
                    fragment.appendChild(nudge);
                }

                els.chatThread.appendChild(fragment);
                if (highlightBubble) {
                    requestAnimationFrame(() => {
                        highlightBubble.scrollIntoView({ behavior: "smooth", block: "start" });
                    });
                } else if (scrollToEnd) {
                    scrollThread();
                }

                if (state.current && state.current.justReceived) {
                    state.current.justReceived = null;
                }

                updateChatHeader();
                updateChatControls();
            }
            function createThinkingBubble() {
                const bubble = document.createElement('article');
                bubble.className = 'bubble thinking';
                const text = document.createElement('p');
                text.textContent = 'Reflection is gathering her thoughts...';
                bubble.appendChild(text);
                const dots = document.createElement('div');
                dots.className = 'typing-dots';
                for (let index = 0; index < 3; index += 1) {
                    dots.appendChild(document.createElement('span'));
                }
                bubble.appendChild(dots);
                return bubble;
            }
            function scrollThread() {
                if (!els.chatThread) return;
                requestAnimationFrame(() => {
                    const target = els.chatThread.scrollHeight;
                    if (typeof els.chatThread.scrollTo === "function") {
                        els.chatThread.scrollTo({ top: target, behavior: "smooth" });
                    } else {
                        els.chatThread.scrollTop = target;
                    }
                });
            }

            function updateChatHeader() {
                if (!state.current) {
                    els.chatTitle.textContent = 'New wish';
                    els.chatSubtitle.textContent = 'Share your wish to begin the conversation.';
                    return;
                }
                const firstUserMessage = state.current.messages.find((msg) => msg.author === 'user');
                const guideCount = state.current.messages.filter((msg) => msg.author === 'guide').length;
                els.chatTitle.textContent = firstUserMessage ? truncateText(firstUserMessage.text, 60) : 'New wish';
                if (state.current.waiting) {
                    els.chatSubtitle.textContent = 'Reflection is crafting a reply under the aurora...';
                } else if (guideCount) {
                    els.chatSubtitle.textContent = `Reflections so far: ${guideCount}`;
                } else {
                    els.chatSubtitle.textContent = 'Share your wish to begin the conversation.';
                }
            }
            function updateChatControls() {
                if (!els.chatSend || !els.chatSave || !els.chatReset || !els.chatInput) return;
                const inputValue = els.chatInput.value.trim();
                const hasEnough = inputValue.replace(/[^a-zA-Z0-9]/g, '').length >= 3;
                const hasMessages = state.current && state.current.messages && state.current.messages.length > 0;
                const hasGuideConversation = state.current && state.current.messages.some((msg) => msg.author === 'guide');
                els.chatSend.disabled = !hasEnough || (state.current && state.current.waiting);
                els.chatSend.textContent = state.current && state.current.messages.length ? 'Send' : 'Send wish';
                els.chatSave.disabled = !hasGuideConversation || (state.current && state.current.waiting) || !state.current.dirty;
                els.chatReset.disabled = !hasMessages || (state.current && state.current.waiting);
                els.chatInput.placeholder = hasMessages ? 'Add your next thought...' : 'Share your wish...';
            }

            function truncateText(text, maxLength) {
                const clean = safeString(text).trim();
                if (clean.length <= maxLength) return clean || 'New wish';
                return clean.slice(0, Math.max(0, maxLength - 3)).trim() + '...';
            }
            function handleSend() {
                if (!state.current || state.current.waiting) {
                    return;
                }
                const note = els.chatInput.value.trim();
                if (note.replace(/[^a-zA-Z0-9]/g, '').length < 3) {
                    showToast('Add a little more detail so the stars know where to guide you.', 'warn');
                    return;
                }

                const message = {
                    id: generateId('msg'),
                    author: 'user',
                    text: note,
                    createdAt: Date.now()
                };
                els.chatInput.value = '';
                autoGrow(els.chatInput);

                const wasEmpty = state.current.messages.length === 0;
                if (wasEmpty) {
                    state.current.wish = note;
                }
                state.current.messages.push(message);
                state.current.updatedAt = Date.now();
                state.current.dirty = true;
                renderChat(true);

                requestReflection(note, wasEmpty);
            }

            async function requestReflection(note, isInitial) {
                state.current.waiting = true;
                state.current.justReceived = null;
                updateChatControls();
                renderChat(true);

                try {
                    const prompt = isInitial
                        ? buildInitialPrompt(note)
                        : buildFollowupPrompt(state.current.wish, state.current.history, note);
                    const reflection = await callReflectionAPI(prompt);
                    if (!reflection) throw new Error('No reflection returned.');
                    const trimmed = reflection.trim();
                    if (!trimmed) throw new Error('Empty reflection.');

                    const guideMessage = {
                        id: generateId('msg'),
                        author: 'guide',
                        text: trimmed,
                        createdAt: Date.now()
                    };
                    await new Promise((resolve) => setTimeout(resolve, 260));
                    state.current.messages.push(guideMessage);
                    state.current.justReceived = guideMessage.id;
                    state.current.history.push(trimmed);
                    state.current.updatedAt = Date.now();
                    state.current.waiting = false;
                    state.current.dirty = true;
                    renderChat(true);
                } catch (error) {
                    console.error(error);
                    state.current.waiting = false;
                    if (state.current) state.current.justReceived = null;
                    showToast('The connection flickered. Please try again in a moment.', 'error', 3600);
                    renderChat(false);
                } finally {
                    updateChatControls();
                }
            }

            function buildInitialPrompt(wish) {
                const cleanWish = sanitize(wish);
                return `${baseGuidance} Diana shares this wish: "${cleanWish}". Reply as Reflection with one vivid paragraph that honours her feeling, offers a fresh angle or question that sharpens her direction, balances warmth with grounded guidance, and ends with an original closing line inviting thoughtful action. If the wish feels unclear or unrelated to a heartfelt intention, gently ask her to reframe it as a wish.`;
            }

            function buildFollowupPrompt(wish, history, note) {
                const cleanWish = sanitize(wish);
                const cleanHistory = Array.isArray(history) ? history.map((entry) => sanitize(entry)) : [];
                const lastReflection = cleanHistory.length ? cleanHistory[cleanHistory.length - 1] : '';
                const earlier = cleanHistory.slice(0, -1).slice(-2);
                const summary = earlier.length ? ' Earlier reflections already offered: ' + earlier.map((text) => `"${text}"`).join(' | ') + '.' : '';
                const cleanNote = sanitize(note);
                return `${baseGuidance} Original wish from Diana: "${cleanWish}". Your latest reflection was: "${lastReflection}".${summary} She now adds: "${cleanNote}". Continue as Reflection with another paragraph under 90 words that acknowledges where the last reflection leaves her, offers a fresh angle or probing question, and finishes with a distinct memorable line. If her note seems confusing or off-topic, kindly guide her back to shaping it as a wish before moving forward.`;
            }
            async function callReflectionAPI(prompt) {
                const response = await fetch('/openai-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                if (!response.ok) {
                    throw new Error('API request failed.');
                }
                const data = await response.json();
                if (data && data.error) {
                    throw new Error(data.error.message || 'Proxy error');
                }
                const message = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
                return sanitize(message);
            }

            function saveConversation() {
                if (!state.current) {
                    showToast('Start a wish before saving to your keepsakes.', 'warn');
                    return;
                }
                const hasGuide = state.current.messages.some((msg) => msg.author === 'guide');
                if (!hasGuide) {
                    showToast('Let Reflection reply before saving this wish.', 'warn');
                    return;
                }

                const entry = {
                    id: state.current.id || generateId('wish'),
                    wish: state.current.wish,
                    messages: state.current.messages.map((message) => ({
                        id: message.id || generateId('msg'),
                        author: message.author === 'guide' ? 'guide' : 'user',
                        text: safeString(message.text).trim(),
                        createdAt: Number.isFinite(message.createdAt) ? message.createdAt : Date.now()
                    })),
                    history: state.current.history.slice(),
                    createdAt: state.current.id ? state.current.createdAt : state.current.createdAt || Date.now(),
                    updatedAt: Date.now()
                };

                const existingIndex = state.saved.findIndex((item) => item.id === entry.id);
                if (existingIndex >= 0) {
                    state.saved.splice(existingIndex, 1, entry);
                } else {
                    state.saved.push(entry);
                }
                state.current.id = entry.id;
                state.current.createdAt = entry.createdAt;
                state.current.updatedAt = entry.updatedAt;
                state.current.dirty = false;

                persistSaved();
                renderSavedList();
                updateChatControls();
                showToast('Wish saved to your keepsakes.', 'info');
            }

            function deleteConversation(id) {
                const index = state.saved.findIndex((entry) => entry.id === id);
                if (index === -1) return;
                const entry = state.saved[index];
                openConfirm('Delete this reflection? It will drift back into the night sky.', (result) => {
                    if (!result) return;
                    state.saved.splice(index, 1);
                    persistSaved();
                    renderSavedList();
                    if (state.current && state.current.id === id) {
                        state.current.id = null;
                        state.current.dirty = true;
                    }
                    showToast('Reflection released.', 'info');
                });
            }

            function downloadConversation(id) {
                const entry = state.saved.find((item) => item.id === id);
                if (!entry) {
                    showToast('That reflection could not be found.', 'error');
                    return;
                }
                const lines = [];
                lines.push(`Wish: ${entry.wish}`);
                lines.push('');
                entry.messages.forEach((message, index) => {
                    const author = message.author === 'guide' ? 'Reflection' : 'Diana';
                    lines.push(`${index + 1}. ${author}`);
                    lines.push(message.text);
                    lines.push('');
                });
                const text = lines.join('\n');
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const timestamp = new Date(entry.updatedAt || Date.now()).toISOString().slice(0, 10);
                link.href = url;
                link.download = `wish-${timestamp}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Download ready.', 'info');
            }

            function renderSavedList() {
                if (!els.savedList) return;
                els.savedList.innerHTML = '';
                if (!state.saved.length) {
                    const empty = document.createElement('div');
                    empty.className = 'saved-empty';
                    const title = document.createElement('h3');
                    title.textContent = 'No saved wishes yet';
                    const hint = document.createElement('p');
                    hint.textContent = 'Save any reflection from the chat to keep it close, download it, or revisit whenever inspiration arrives.';
                    empty.appendChild(title);
                    empty.appendChild(hint);
                    els.savedList.appendChild(empty);
                    return;
                }

                const sorted = state.saved.slice().sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                const fragment = document.createDocumentFragment();

                sorted.forEach((entry) => {
                    const card = document.createElement('li');
                    card.className = 'saved-card';
                    card.dataset.id = entry.id;
                    if (state.current && state.current.id === entry.id) {
                        card.classList.add('is-current');
                    }

                    const header = document.createElement('header');
                    const title = document.createElement('h3');
                    title.textContent = entry.wish ? truncateText(entry.wish, 80) : 'Untitled wish';
                    const preview = document.createElement('p');
                    const lastGuide = (entry.messages || []).slice().reverse().find((msg) => msg.author === 'guide');
                    preview.textContent = lastGuide ? truncateText(lastGuide.text, 120) : 'No reflections captured yet.';
                    header.appendChild(title);
                    header.appendChild(preview);

                    const meta = document.createElement('div');
                    meta.className = 'saved-meta';
                    const count = document.createElement('span');
                    const messageCount = entry.messages ? entry.messages.length : 0;
                    count.textContent = `${messageCount} message${messageCount === 1 ? '' : 's'}`;
                    const updated = document.createElement('span');
                    const updatedDate = entry.updatedAt ? new Date(entry.updatedAt) : new Date();
                    updated.textContent = `Updated ${formatDate(updatedDate)}`;
                    meta.appendChild(count);
                    meta.appendChild(updated);

                    const actions = document.createElement('div');
                    actions.className = 'saved-actions';

                    const continueBtn = document.createElement('button');
                    continueBtn.type = 'button';
                    continueBtn.className = 'primary';
                    continueBtn.dataset.action = 'open';
                    continueBtn.textContent = 'Continue';
                    actions.appendChild(continueBtn);

                    const downloadBtn = document.createElement('button');
                    downloadBtn.type = 'button';
                    downloadBtn.className = 'secondary';
                    downloadBtn.dataset.action = 'download';
                    downloadBtn.textContent = 'Download';
                    actions.appendChild(downloadBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'delete secondary';
                    deleteBtn.dataset.action = 'delete';
                    deleteBtn.textContent = 'Delete';
                    actions.appendChild(deleteBtn);

                    card.appendChild(header);
                    card.appendChild(meta);
                    card.appendChild(actions);
                    fragment.appendChild(card);
                });

                els.savedList.appendChild(fragment);
            }

            function persistSaved() {
                try {
                    localStorage.setItem(storeKey, JSON.stringify(state.saved));
                } catch (error) {
                    console.error('Unable to persist reflections', error);
                    showToast('Storage is unavailable. Changes may not be saved.', 'error', 4000);
                }
            }

            function loadSaved() {
                let stored = [];
                try {
                    const raw = localStorage.getItem(storeKey);
                    if (raw) {
                        const parsed = JSON.parse(raw);
                        if (Array.isArray(parsed)) {
                            stored = parsed.map(normalizeEntry).filter(Boolean);
                        }
                    }
                } catch (error) {
                    console.error('Unable to load reflections', error);
                    stored = [];
                }
                state.saved = stored;
                persistSaved();
                renderSavedList();
            }
            function normalizeEntry(entry) {
                if (!entry) return null;
                if (entry.messages && Array.isArray(entry.messages)) {
                    const normalizedMessages = entry.messages.map((message) => ({
                        id: message.id || generateId('msg'),
                        author: message.author === 'guide' ? 'guide' : 'user',
                        text: safeString(message.text).trim(),
                        createdAt: Number.isFinite(message.createdAt) ? message.createdAt : Date.now()
                    })).filter((message) => message.text.length);
                    return {
                        id: entry.id || generateId('wish'),
                        wish: entry.wish || (normalizedMessages[0] && normalizedMessages[0].author === 'user' ? normalizedMessages[0].text : ''),
                        messages: normalizedMessages,
                        history: Array.isArray(entry.history) && entry.history.length ? entry.history.map((item) => safeString(item).trim()) : deriveHistory(normalizedMessages),
                        createdAt: Number.isFinite(entry.createdAt) ? entry.createdAt : Date.now(),
                        updatedAt: Number.isFinite(entry.updatedAt) ? entry.updatedAt : Date.now()
                    };
                }

                if (entry.timeline && Array.isArray(entry.timeline)) {
                    const messages = entry.timeline.map((item, index) => {
                        const author = item.type === 'guide' ? 'guide' : 'user';
                        return {
                            id: generateId('msg'),
                            author,
                            text: safeString(item.text).trim(),
                            createdAt: Date.now() - (entry.timeline.length - index) * 60000
                        };
                    }).filter((message) => message.text.length);
                    return {
                        id: entry.id || generateId('wish'),
                        wish: entry.wish || (messages[0] && messages[0].author === 'user' ? messages[0].text : ''),
                        messages,
                        history: deriveHistory(messages),
                        createdAt: Number.isFinite(entry.createdAt) ? entry.createdAt : Date.now(),
                        updatedAt: Number.isFinite(entry.updatedAt) ? entry.updatedAt : Date.now()
                    };
                }

                if (entry.history && Array.isArray(entry.history) && entry.wish) {
                    const messages = [];
                    messages.push({
                        id: generateId('msg'),
                        author: 'user',
                        text: safeString(entry.wish).trim(),
                        createdAt: Date.now()
                    });
                    entry.history.forEach((reflection, index) => {
                        messages.push({
                            id: generateId('msg'),
                            author: 'guide',
                            text: safeString(reflection).trim(),
                            createdAt: Date.now() + (index + 1) * 60000
                        });
                    });
                    return {
                        id: entry.id || generateId('wish'),
                        wish: safeString(entry.wish).trim(),
                        messages,
                        history: entry.history.map((item) => safeString(item).trim()),
                        createdAt: Number.isFinite(entry.createdAt) ? entry.createdAt : Date.now(),
                        updatedAt: Number.isFinite(entry.updatedAt) ? entry.updatedAt : Date.now()
                    };
                }

                return null;
            }

            function formatDate(date) {
                if (!(date instanceof Date) || Number.isNaN(date.getTime())) return 'just now';
                return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
            }

            function autoGrow(textarea) {
                if (!textarea) return;
                textarea.style.height = 'auto';
                textarea.style.height = `${Math.min(180, textarea.scrollHeight)}px`;
            }

            function handleSavedListClick(event) {
                const button = event.target.closest('button[data-action]');
                if (!button) return;
                const card = button.closest('.saved-card');
                if (!card) return;
                const id = card.dataset.id;
                if (!id) return;
                switch (button.dataset.action) {
                    case 'open': {
                        const entry = state.saved.find((item) => item.id === id);
                        if (!entry) {
                            showToast('That reflection could not be found.', 'error');
                            return;
                        }
                        openChat(entry);
                        break;
                    }
                    case 'download':
                        downloadConversation(id);
                        break;
                    case 'delete':
                        deleteConversation(id);
                        break;
                    default:
                        break;
                }
            }

            function handleKeyDown(event) {
                if (event.key === 'Escape') {
                    if (els.confirmSheet && els.confirmSheet.classList.contains('is-active')) {
                        event.preventDefault();
                        closeConfirm(false);
                        return;
                    }
                    if (els.infoSheet && els.infoSheet.classList.contains('is-active')) {
                        event.preventDefault();
                        hideInfo();
                        return;
                    }
                    if (els.screenChat && els.screenChat.classList.contains('is-active')) {
                        event.preventDefault();
                        closeChat(true);
                        return;
                    }
                }
            }

            function setupEvents() {
                if (els.menuStart) {
                    els.menuStart.addEventListener('click', () => {
                        startFreshConversation();
                        openChat();
                    });
                }
                if (els.menuSaved) {
                    els.menuSaved.addEventListener('click', () => {
                        renderSavedList();
                        showSaved();
                    });
                }
                if (els.menuInfo) {
                    els.menuInfo.addEventListener('click', showInfo);
                }
                if (els.infoClose) {
                    els.infoClose.addEventListener('click', hideInfo);
                }
                if (els.savedBack) {
                    els.savedBack.addEventListener('click', showMenu);
                }
                if (els.savedList) {
                    els.savedList.addEventListener('click', handleSavedListClick);
                }
                if (els.chatClose) {
                    els.chatClose.addEventListener('click', () => closeChat(true));
                }
                if (els.chatSend) {
                    els.chatSend.addEventListener('click', handleSend);
                }
                if (els.chatInput) {
                    els.chatInput.addEventListener('input', () => {
                        autoGrow(els.chatInput);
                        updateChatControls();
                    });
                    els.chatInput.addEventListener('keydown', (event) => {
                        if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                            event.preventDefault();
                            handleSend();
                        }
                    });
                }
                if (els.chatSave) {
                    els.chatSave.addEventListener('click', saveConversation);
                }
                if (els.chatReset) {
                    els.chatReset.addEventListener('click', () => {
                        if (!state.current || !state.current.messages.length) return;
                        openConfirm('Start over with a fresh wish?', (result) => {
                            if (!result) return;
                            startFreshConversation();
                            renderChat(true);
                        });
                    });
                }
                if (els.introSkip) {
                    els.introSkip.addEventListener('click', hideIntro);
                }
                if (els.confirmYes) {
                    els.confirmYes.addEventListener('click', () => closeConfirm(true));
                }
                if (els.confirmNo) {
                    els.confirmNo.addEventListener('click', () => closeConfirm(false));
                }
                document.addEventListener('keydown', handleKeyDown);
                window.addEventListener('beforeunload', hideToast);
            }

            function init() {
                autoGrow(els.chatInput);
                loadSaved();
                renderChat(false);
                setupEvents();
                window.setTimeout(() => {
                    if (els.intro) hideIntro();
                }, 48000);
            }

            init();
            window.birthdayAppState = state;
        })();
    </script>
</body>
</html>
















































































